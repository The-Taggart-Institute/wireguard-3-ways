<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Going Live: Leaving the Test Kitchen - Wireguard 3 Ways: Cooking up Privacy in a Surveillance State</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Wireguard 3 Ways: Cooking up Privacy in a Surveillance State</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="going-live-leaving-the-test-kitchen"><a class="header" href="#going-live-leaving-the-test-kitchen">Going Live: Leaving the Test Kitchen</a></h1>
<p>Our recipes so far have demonstrated the concepts behind Wireguard networking in a safe, contained (and containerized) environment. But now it's time to start building our real private network. In this section, we walk through creating a real-deal Headscale server in the cloud.</p>
<blockquote>
<p>"But Taggart, you can't trust the cloud!"</p>
</blockquote>
<p>You can use a thing without trusting it. The value proposition of the cloud VM is its visibility from everywhere. But if we do this right (e.g. a proper Headscale setup), we won't be trusting it for too much. Its job will be to negotiate the initial connection between peers, and then let the Tailscale "magic" establish peer-to-peer connections, keeping the lighthouse out of the picture entirely.</p>
<p>Let's get going.</p>
<h2 id="required-materials"><a class="header" href="#required-materials">Required Materials</a></h2>
<p>This is the part of the workshop that costs some money. To complete this setup as we've done it, you'll need:</p>
<ol>
<li>A registered domain name that you can control</li>
<li>A cloud VM</li>
</ol>
<p>The cloud VM doesn't have to be huge. Entry-level VMs on all major VPSes will be just fine.</p>
<h2 id="create-the-cloud-vm"><a class="header" href="#create-the-cloud-vm">Create the Cloud VM</a></h2>
<p>It all starts with the cloud VM. I'm going to use <a href="https://digitalocean.com">Digital Ocean</a> to demo the process, but if you're comfortabel with <code>AWS|Azure|Vultr|Hetzner</code>, go for it.</p>
<p>For commonality's sake, we'll use Ubuntu 24.04 LTS as our base. However, this choice means we'll need to manually install a newer version of Podman than is available directly from the package manager.</p>
<p>Different cloud providers have different methods of securing their VMs, but I strongly recommend the following best practices:</p>
<ul>
<li>Use SSH Key authentication</li>
<li>Use firewall rules to limit SSH access to certain source IP addresses</li>
</ul>
<p>Log in to the VM via SSH (or cloud console, if appropriate).</p>
<h3 id="housekeeping"><a class="header" href="#housekeeping">Housekeeping</a></h3>
<p>We want to perform the following housekeeping measures, as needed:</p>
<ol>
<li>Create a new, non-root user</li>
<li>Make sure our SSH Keys are present on the new user and that we can log in with it</li>
<li>Disable root login</li>
<li>Add firewall rules to allow HTTP/HTTPS traffic (80/tcp, 443/tcp)</li>
</ol>
<blockquote>
<p>Hey if you wanna get extra sneaky, change the ports you're using for SSH and HTTPS, but for now we'll leave these default.</p>
</blockquote>
<h2 id="install-headscale"><a class="header" href="#install-headscale">Install Headscale</a></h2>
<p>Head to the <a href="https://github.com/juanfont/headscale/releases/latest">Headscale Releases</a> and download the latest Headscale version.</p>
<p>For our server, we want the <code>linux_amd64.deb</code> version. Copy that link's URL and then use it like so:</p>
<pre><code class="language-bash">wget https://github.com/juanfont/headscale/releases/download/v0.26.1/headscale_0.26.1_linux_amd64.deb
sudo dpkg -i headscale*.deb
</code></pre>
<p>If all goes well, you'll see some instructions to enable and start the <code>headscale</code> service. Let's do so.</p>
<pre><code class="language-bash">sudo systemctl enable headscale
sudo systemctl start headscale
</code></pre>
<p>Now comes the configuration part. We'll start with the users.</p>
<h2 id="create-headscale-users"><a class="header" href="#create-headscale-users">Create Headscale users</a></h2>
<p>For now, we'll just create one user, but for your real network, you can make as many as you need. Remember that machines are associated with users, so think about how you want to link those conceptually.</p>
<pre><code class="language-bash">sudo headscale users create hope -d hope-demo
</code></pre>
<p>And right away we'll create a preauthkey for use when we're ready to connect a client.</p>
<pre><code class="language-bash">sudo headscale preauthkeys create -u 1
</code></pre>
<p>Copy that and save it for later.</p>
<h2 id="configure-headscale-server"><a class="header" href="#configure-headscale-server">Configure Headscale Server</a></h2>
<p>Now we need to edit the Headscale config to match our domain. Got the domain you intend to use? Great. We don't need to modify the DNS records <em>yet</em>, but it's coming up. For now, use Nano, Vim, or Helix (<code>sudo snap install helix --classic</code>). With any of those, open up <code>/etc/headscale/config.yaml</code> with <code>sudo</code>.</p>
<p>Change <code>server_url</code> to <code>https://the-domain-you-chose.com:443</code></p>
<p>Change <code>listen_addr</code> to <code>0.0.0.0:443</code></p>
<p>Change <code>acme_email</code> to an email address you feel comfortable giving to LetsEncrypt.</p>
<p>Change <code>tls_letsencrypt_hostname</code> to <code>the-domain-you-chose.com</code></p>
<p>And that's all we need to change for now. If you looked closely at the setup for Headscale in our recipes, you saw we configured a custom certificate for Headscale on startup. But now that we're on the internet proper, we can use <a href="https://letsencrypt.org">LetsEncrypt</a> to grab a certificate.</p>
<p>Save and quit.</p>
<h2 id="configure-dns"><a class="header" href="#configure-dns">Configure DNS</a></h2>
<p>Time to head to your DNS registrar! Create a new <code>A</code> record for the domain name you've selected and point it at the IP address of your cloud VM.</p>
<p>Give it a few minutes for the record to propagate. You can test it with <code>nslookup the-domain-you-chose.com</code>.</p>
<p>Once it's ready, head back to your server and restart Headscale.</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl restart headscale
</code></pre>
<h2 id="connect-a-client-or-two"><a class="header" href="#connect-a-client-or-two">Connect a Client Or Two</a></h2>
<p>Now comes the fun part. Using the Tailscale Client, connect to the Headscale server. Here's how it looks on Linux:</p>
<pre><code class="language-bash">sudo tailscale up --login-server=https://the-domain-you-chose.com --auth-key=the-authkey-you-created --accept-routes
</code></pre>
<p>Congratulations! You've created a Headscale network.</p>
<h2 id="going-further"><a class="header" href="#going-further">Going Further</a></h2>
<p>Now that you have a way of connected trusts endpoints and networks together for secure communications, you can explore using some of these endpoints as <a href="https://tailscale.com/kb/1103/exit-nodes">exit nodes</a> to alter where your internet traffic comes from. You can also explore <a href="https://tailscale.com/kb/1054/dns">DNS</a> for your network to make it easier to reference endpoints.</p>
<p>You can also explore <a href="https://headscale.net/stable/ref/acls/">access control</a> for more granular control of your hosts.</p>
<p>But for now, take a moment and congratulate yourself. You've just taken a big step toward owning your digital privacy. You're using the cloud, but on your terms.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="recipe-3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="recipe-3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>



    </div>
    </body>
</html>
